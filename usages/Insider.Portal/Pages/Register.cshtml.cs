using System.ComponentModel.DataAnnotations;
using Husky.Authentication.Abstractions;
using Husky.Injection;
using Husky.Sugar;
using Insider.Portal.Controllers;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;

namespace Insider.Portal.Pages
{
	public class RegisterModel : PageModel
	{
		public RegisterModel(IPrincipal principal) {
			_my = principal;
		}

		readonly IPrincipal _my;

		const string _typeName = "邮箱";
		public AccountNameType AccountNameType => AccountNameType.Email;

		[Required(ErrorMessage = "必须填写，请用您的" + _typeName + "作为帐号名。")]
		[EmailAddress(ErrorMessage = "格式无效，请用您的" + _typeName + "作为帐号名。")]
		[RegularExpression(StringTest.EmailRegexPattern, ErrorMessage = "格式无效，请用您的" + _typeName + "作为帐号名。")]
		[Remote(nameof(ApiController.IsAccountApplicable), "Api", AdditionalFields = nameof(AccountNameType), HttpMethod = "POST", ErrorMessage = "{0}已经被注册了。")]
		[Display(Name = _typeName)]
		public string AccountName { get; set; }

		[Required(ErrorMessage = "密码必须填写。")]
		[StringLength(18, MinimumLength = 8, ErrorMessage = "密码长度须在{2}-{1}位之间。")]
		[DataType(DataType.Password)]
		[Display(Name = "密码")]
		public string Password { get; set; }

		[Required(ErrorMessage = "重复输入一遍密码。")]
		[MaxLength(15), Compare(nameof(Password), ErrorMessage = "两次密码输入不一致。")]
		[DataType(DataType.Password)]
		[Display(Name = "密码确认")]
		public string PasswordConfirm { get; set; }

		public void OnGet() {
		}

		public async void OnPost() {
			if ( ModelState.IsValid ) {
				var result = await _my.User().SignUp(AccountNameType, AccountName, Password, verified: false);
				if ( result.Ok ) {
					//return View(nameof(Verify), new RegistryVerifyModel { AccountName = AccountName, AutoSend = true });
				}
				ModelState.AddModelError(nameof(AccountName), result.Message);
			}
		}
	}
}